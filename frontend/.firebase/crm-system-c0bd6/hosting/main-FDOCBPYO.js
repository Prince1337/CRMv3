import{a as m}from"./chunk-R3BKSPTG.js";import"./chunk-562UQ2XR.js";import{a as $,c as G,d as l,e as Z,f as X,g as Y}from"./chunk-BYEZXU77.js";import{G as P,I as O,Ia as R,Jb as B,Ka as D,L as f,Na as a,Nb as H,Oa as i,Pa as L,Q as p,R as g,Sa as E,Ta as F,Tb as N,Ua as b,Ub as K,Vb as V,W as I,Za as s,_a as j,ab as z,ca as T,da as y,g as A,gb as U,k as v,n as d,u as S,v as M,va as C,y as w}from"./chunk-ZEIBLRTY.js";import"./chunk-CWTPBX7D.js";var u=(()=>{class t{constructor(e,n){this.authService=e,this.router=n}canActivate(){return this.authService.isAuthenticatedAsync().pipe(d(e=>{if(e)return!0;{let n=this.router.url;return n!=="/login"&&n!=="/register"&&this.router.navigate(["/login"]),!1}}))}static{this.\u0275fac=function(n){return new(n||t)(p(m),p(l))}}static{this.\u0275prov=f({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();var Q=(()=>{class t{constructor(e,n){this.authService=e,this.router=n}canActivate(e){let n=e.data.roles;return!n||n.length===0?!0:this.authService.isAuthenticatedAsync().pipe(d(o=>o?n.some(et=>this.authService.hasRole(et))?!0:(this.router.navigate(["/unauthorized"]),!1):(this.router.navigate(["/login"]),!1)))}static{this.\u0275fac=function(n){return new(n||t)(p(m),p(l))}}static{this.\u0275prov=f({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();var W=[{path:"",redirectTo:"/dashboard",pathMatch:"full"},{path:"login",loadComponent:()=>import("./chunk-TJTWR7KO.js").then(t=>t.LoginComponent)},{path:"register",loadComponent:()=>import("./chunk-W4QKDLLM.js").then(t=>t.RegisterComponent)},{path:"unauthorized",loadComponent:()=>import("./chunk-3PPEP6AG.js").then(t=>t.UnauthorizedComponent)},{path:"dashboard",loadComponent:()=>import("./chunk-526KAMAW.js").then(t=>t.DashboardComponent),canActivate:[u]},{path:"customers",loadComponent:()=>import("./chunk-YOI3CBCE.js").then(t=>t.CustomerListComponent),canActivate:[u]},{path:"customers/new",loadComponent:()=>import("./chunk-RSAWQ3LC.js").then(t=>t.CustomerFormComponent),canActivate:[u]},{path:"customers/pipeline",loadComponent:()=>import("./chunk-XEVPNRE6.js").then(t=>t.PipelineComponent),canActivate:[u]},{path:"customers/:id",loadComponent:()=>import("./chunk-FHOC2JEU.js").then(t=>t.CustomerDetailComponent),canActivate:[u]},{path:"customers/:id/edit",loadComponent:()=>import("./chunk-RSAWQ3LC.js").then(t=>t.CustomerFormComponent),canActivate:[u]},{path:"statistics",loadComponent:()=>import("./chunk-HA5QVPDX.js").then(t=>t.StatisticsComponent),canActivate:[u,Q],data:{roles:["ROLE_ADMIN"]}},{path:"offers",loadChildren:()=>import("./chunk-AZPWCUNM.js").then(t=>t.OFFER_ROUTES),canActivate:[u]},{path:"**",redirectTo:"/dashboard"}];var h=!1,_=new A(null),at=["/auth/login","/auth/register","/auth/validate"];function it(t){return at.some(r=>t.includes(r))}function k(t,r){return t.clone({setHeaders:{Authorization:`Bearer ${r}`}})}function ct(){return localStorage.getItem("accessToken")}function st(){return localStorage.getItem("refreshToken")}function ut(){localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user")}function x(t){ut(),t.navigate(["/login"])}function lt(t,r,e){if(console.log("AuthInterceptor: 401-Fehler erkannt, versuche Token-Refresh"),h)return console.log("AuthInterceptor: Token-Refresh l\xE4uft bereits, warte auf Ergebnis"),_.pipe(S(n=>n!==null),w(1),P(n=>r(k(t,n))));{h=!0,_.next(null);let n=st();return n?g(N).post("http://localhost:8080/api/auth/refresh",{},{headers:{Authorization:`Bearer ${n}`}}).pipe(O(c=>{console.log("AuthInterceptor: Token erfolgreich erneuert"),localStorage.setItem("accessToken",c.accessToken),localStorage.setItem("refreshToken",c.refreshToken),h=!1,_.next(c.accessToken)}),P(c=>r(k(t,c.accessToken))),M(c=>(console.error("AuthInterceptor: Token-Refresh fehlgeschlagen:",c),h=!1,_.next(null),x(e),v(()=>c)))):(console.error("AuthInterceptor: Kein Refresh-Token verf\xFCgbar"),h=!1,x(e),v(()=>new Error("Kein Refresh-Token verf\xFCgbar")))}}function pt(t,r,e){return console.warn("AuthInterceptor: 403-Fehler - Zugriff verweigert"),x(e),v(()=>new Error("Zugriff verweigert"))}var q=(t,r)=>{let e=g(l);if(it(t.url))return console.log("AuthInterceptor: URL ausgeschlossen:",t.url),r(t);let n=ct();return n&&(t=k(t,n)),r(t).pipe(O(o=>{}),M(o=>{switch(console.error("AuthInterceptor: HTTP-Fehler:",o.status,"f\xFCr URL:",t.url),o.status){case 401:if(!t.url.includes("/auth/refresh"))return lt(t,r,e);break;case 403:return pt(t,r,e);case 0:console.error("AuthInterceptor: Netzwerk-Fehler - m\xF6glicherweise Server nicht erreichbar");break;default:console.error("AuthInterceptor: Unbehandelter HTTP-Fehler:",o.status)}return v(()=>o)}))};var tt={providers:[Y(W),K(V([q]))]};function gt(t,r){if(t&1){let e=E();a(0,"nav",3)(1,"div",4)(2,"a",5),s(3," \u{1F3E2} CRM v3 "),i(),a(4,"div",6)(5,"a",7),s(6," \u{1F4CA} Dashboard "),i(),a(7,"a",8),s(8," \u{1F465} Kunden "),i(),a(9,"a",9),s(10," \u{1F4C8} Pipeline "),i(),a(11,"a",10),s(12," \u{1F4CA} Statistiken "),i(),a(13,"div",11)(14,"div",12)(15,"div",13),s(16),i(),a(17,"div",14),s(18),i()(),a(19,"button",15),F("click",function(){T(e);let o=b();return y(o.logout())}),s(20," \u{1F6AA} Logout "),i()()()()()}if(t&2){let e,n,o=b();C(16),z("",(e=o.authService.getCurrentUser())==null?null:e.firstName," ",(e=o.authService.getCurrentUser())==null?null:e.lastName,""),C(2),j((n=o.authService.getCurrentUser())==null?null:n.role)}}var nt=(()=>{class t{constructor(){this.authService=g(m),this.router=g(l)}ngOnInit(){this.authSubscription=this.authService.authState$.subscribe(e=>{let n=this.router.url;console.log("AuthState ge\xE4ndert:",e.isAuthenticated,"Aktueller Pfad:",n),e.isAuthenticated&&(n==="/login"||n==="/register")&&this.router.navigate(["/dashboard"])})}ngOnDestroy(){this.authSubscription&&this.authSubscription.unsubscribe()}logout(){console.log("Logout wird ausgef\xFChrt..."),this.authService.handleLogout();try{this.authService.logout().subscribe({next:e=>{console.log("Backend-Logout erfolgreich:",e)},error:e=>{console.error("Backend-Logout error:",e)}})}catch(e){console.error("Fehler beim Backend-Logout:",e)}this.router.navigate(["/login"])}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["app-root"]],standalone:!0,features:[U],decls:4,vars:1,consts:[[1,"app-container"],["class","nav-container",4,"ngIf"],[1,"main-content"],[1,"nav-container"],[1,"nav-content"],["routerLink","/dashboard",1,"nav-brand"],[1,"nav-menu"],["routerLink","/dashboard","routerLinkActive","active",1,"nav-link"],["routerLink","/customers","routerLinkActive","active",1,"nav-link"],["routerLink","/customers/pipeline","routerLinkActive","active",1,"nav-link"],["routerLink","/statistics","routerLinkActive","active",1,"nav-link"],[1,"nav-user"],[1,"user-info"],[1,"user-name"],[1,"user-role"],[1,"logout-btn",3,"click"]],template:function(n,o){n&1&&(a(0,"div",0),R(1,gt,21,3,"nav",1),a(2,"main",2),L(3,"router-outlet"),i()()),n&2&&(C(),D("ngIf",o.authService.isAuthenticated()))},dependencies:[H,B,G,Z,X],styles:[".app-container[_ngcontent-%COMP%]{min-height:100vh;background-color:var(--apple-gray-1)}.nav-container[_ngcontent-%COMP%]{background:#fff;box-shadow:var(--shadow-sm);border-bottom:1px solid var(--apple-gray-2);padding:var(--spacing-md) var(--spacing-xl)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;max-width:1400px;margin:0 auto}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-brand[_ngcontent-%COMP%]{font-size:var(--font-size-xl);font-weight:600;color:var(--apple-gray-11);text-decoration:none}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-brand[_ngcontent-%COMP%]:hover{color:var(--apple-blue)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]{display:flex;gap:var(--spacing-lg);align-items:center}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]{color:var(--apple-gray-8);text-decoration:none;font-weight:500;padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--radius-md);transition:all var(--transition-normal)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]:hover{color:var(--apple-blue);background:var(--apple-gray-1)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-link.active[_ngcontent-%COMP%]{color:var(--apple-blue);background:#007aff1a}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--spacing-sm)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]   .user-info[_ngcontent-%COMP%]{text-align:right}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]   .user-info[_ngcontent-%COMP%]   .user-name[_ngcontent-%COMP%]{font-weight:500;color:var(--apple-gray-11);font-size:var(--font-size-sm)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]   .user-info[_ngcontent-%COMP%]   .user-role[_ngcontent-%COMP%]{color:var(--apple-gray-6);font-size:var(--font-size-xs)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]   .logout-btn[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;gap:var(--spacing-sm);padding:var(--spacing-sm) var(--spacing-md);border:none;border-radius:var(--radius-md);font-size:var(--font-size-xs);font-weight:500;cursor:pointer;transition:all var(--transition-normal);text-decoration:none;min-width:80px;background:var(--apple-gray-5);color:#fff}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]   .logout-btn[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--apple-gray-6);transform:translateY(-1px);box-shadow:var(--shadow-lg)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]   .logout-btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]   .logout-btn[_ngcontent-%COMP%]:focus{outline:none;box-shadow:0 0 0 3px #007aff33}.main-content[_ngcontent-%COMP%]{min-height:calc(100vh - 80px);background:var(--apple-gray-1)}@media (max-width: 768px){.nav-container[_ngcontent-%COMP%]{padding:var(--spacing-sm) var(--spacing-md)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]{flex-direction:column;gap:var(--spacing-md)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]{flex-direction:column;width:100%}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]{flex-direction:column;gap:var(--spacing-sm)}.nav-container[_ngcontent-%COMP%]   .nav-content[_ngcontent-%COMP%]   .nav-menu[_ngcontent-%COMP%]   .nav-user[_ngcontent-%COMP%]   .user-info[_ngcontent-%COMP%]{text-align:center}}"]})}}return t})();$(nt,tt).catch(t=>console.error(t));
